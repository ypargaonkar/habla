generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(cuid())
  email            String   @unique
  passwordHash     String
  name             String
  currentLevel     String   @default("A1")
  learningGoal     String   @default("personal")
  dailyGoalMinutes Int      @default(15)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  progress         UserProgress[]
  speechRecordings SpeechRecording[]
  vocabulary       UserVocabulary[]
  weakAreas        UserWeakArea[]
  userLessons      UserLesson[]
  conversations    ConversationSession[]
}

model UserProgress {
  id                 String   @id @default(cuid())
  userId             String
  date               DateTime @db.Date
  minutesPracticed   Int      @default(0)
  exercisesCompleted Int      @default(0)
  speakingScore      Float?
  createdAt          DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model SpeechRecording {
  id                 String   @id @default(cuid())
  userId             String
  exerciseId         String?
  audioUrl           String
  transcription      String?
  expectedText       String?
  pronunciationScore Float?
  fluencyScore       Float?
  grammarScore       Float?
  feedback           Json?
  createdAt          DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserVocabulary {
  id           String   @id @default(cuid())
  userId       String
  word         String
  translation  String
  context      String?
  easeFactor   Float    @default(2.5)
  intervalDays Int      @default(1)
  nextReview   DateTime @default(now())
  reviewCount  Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, word])
}

model UserWeakArea {
  id              String   @id @default(cuid())
  userId          String
  areaType        String   // 'pronunciation', 'grammar', 'vocabulary'
  specificItem    String   // e.g., 'r_sound', 'ser_estar'
  occurrenceCount Int      @default(1)
  lastOccurred    DateTime @default(now())
  addressed       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, areaType, specificItem])
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String
  level       String
  scenario    String
  orderIndex  Int
  content     Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userLessons UserLesson[]

  @@unique([level, orderIndex])
}

model UserLesson {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  status      String    @default("not_started") // 'not_started', 'in_progress', 'completed'
  score       Float?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model ConversationSession {
  id        String   @id @default(cuid())
  userId    String
  scenario  String?
  messages  Json     @default("[]")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
